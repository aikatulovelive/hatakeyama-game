<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>ハタケヤマゲーム - 魁 - 真の完全版</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; display: flex; justify-content: center; align-items: center; height: 100vh; color: #fff; font-family: "Hiragino Mincho ProN", "MS Mincho", serif; touch-action: none; }
        .container { position: relative; text-align: center; width: 100%; max-width: 800px; }
        h1 { margin: 0 0 5px 0; color: #d4af37; text-shadow: 0 0 15px #d4af37; font-size: 18px; letter-spacing: 0.2em; }
        canvas { border: 2px solid #d4af37; background: #000; width: 100%; height: auto; touch-action: none; cursor: crosshair; }
        .ui { position: absolute; bottom: -35px; width: 100%; display: flex; justify-content: space-between; font-size: 14px; color: #d4af37; font-weight: bold; }
        #bossHpBar { position: absolute; top: 10px; left: 10%; width: 80%; height: 8px; background: #300; border: 1px solid #d4af37; display: none; z-index: 10; }
        #bossHpInner { width: 100%; height: 100%; background: #f00; transition: width 0.1s; }
        #bombBtn { 
            position: absolute; bottom: 15px; right: 15px; width: 55px; height: 55px; 
            background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(212, 175, 55, 0.2); 
            border-radius: 50%; color: rgba(255, 255, 255, 0.2); 
            display: flex; justify-content: center; align-items: center; font-size: 12px; 
            z-index: 100; user-select: none; transition: all 0.3s;
        }
        #bombBtn.ready { 
            background: rgba(212, 175, 55, 0.4); border: 2px solid #d4af37; 
            color: #fff; box-shadow: 0 0 15px #d4af37; font-weight: bold;
        }
        #bombBtn:active { transform: scale(0.9); background: rgba(212, 175, 55, 0.8); }
    </style>
</head>
<body>
    <div class="container">
        <div id="bossHpBar"><div id="bossHpInner"></div></div>
        <h1>ハタケヤマゲーム</h1>
        <canvas id="gameCanvas"></canvas>
        <div id="bombBtn">悟り</div>
        <div class="ui">
            <div id="scoreDisp">徳: 0</div>
            <div id="timerDisp">修行中...</div>
        </div>
    </div>

    <script>
        const canvas = document.getElementById('gameCanvas');
        const ctx = canvas.getContext('2d');
        canvas.width = 800; canvas.height = 400;

        const bgImg = new Image(); bgImg.src = 'bg.png';
        const enemyImg = new Image(); enemyImg.src = 'yoku.png';
        const bossImg = new Image(); bossImg.src = 'boss.png';

        let score = 0;
        let gameOver = false;
        let gameClear = false;
        let frames = 0;
        let bgX = 0;
        const keys = {};
        const player = { x: 60, y: 180, size: 40 };
        let bullets = [];
        let enemies = [];
        let particles = [];
        let petals = [];

        let lastTouchX = 0;
        let lastTouchY = 0;

        canvas.addEventListener('touchstart', e => {
            if (gameOver || gameClear) { location.reload(); return; }
            const touch = e.touches[0];
            lastTouchX = touch.clientX;
            lastTouchY = touch.clientY;
        }, { passive: false });

        canvas.addEventListener('touchmove', e => {
            e.preventDefault();
            if (gameOver || gameClear) return;
            const touch = e.touches[0];
            const dx = (touch.clientX - lastTouchX) * 1.5;
            const dy = (touch.clientY - lastTouchY) * 1.5;
            player.x = Math.max(0, Math.min(canvas.width - player.size, player.x + dx));
            player.y = Math.max(0, Math.min(canvas.height - player.size, player.y + dy));
            lastTouchX = touch.clientX;
            lastTouchY = touch.clientY;
            if (frames % 6 === 0) fireBullet();
        }, { passive: false });

        const bombBtn = document.getElementById('bombBtn');
        bombBtn.addEventListener('touchstart', e => { e.preventDefault(); useBomb(); });

        function fireBullet() { if (!gameOver && !gameClear) bullets.push({ x: player.x + player.size, y: player.y + 20, r: 5, speed: 14 }); }
        
        function useBomb() {
            if (score >= 540 && !gameOver && !gameClear) {
                score -= 540;
                enemies.forEach(en => createExplosion(en.x + 15, en.y + 15, '#fff'));
                enemies = [];
                ctx.fillStyle = 'rgba(255, 255, 255, 0.8)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
            }
        }

        window.addEventListener('keydown', e => { keys[e.code] = true; if (e.code === 'KeyB') useBomb(); });
        window.addEventListener('keyup', e => keys[e.code] = false);

        function createExplosion(x, y, color = '#d4af37') {
            for(let i=0; i<15; i++) particles.push({ x, y, vx: (Math.random()-0.5)*15, vy: (Math.random()-0.5)*15, life: 50, size: Math.random()*5, color: color });
        }

        function createPetals() {
            for(let i=0; i<50; i++) petals.push({ x: Math.random() * canvas.width, y: -20 - Math.random() * 400, size: 10 + Math.random() * 15, vx: (Math.random() - 0.5) * 2, vy: 1 + Math.random() * 2, angle: Math.random() * Math.PI * 2, va: (Math.random() - 0.5) * 0.05, color: Math.random() > 0.5 ? '#ffd1dc' : '#ffffff' });
        }

        function getRank(s) {
            if (s >= 15000) return { name: "如来 (極)", color: "#fff700" };
            if (s >= 10000) return { name: "菩薩", color: "#ffa500" };
            if (s >= 7000) return { name: "阿羅漢", color: "#00ffcc" };
            return { name: "修行僧", color: "#aaa" };
        }

        const boss = { active: false, x: 900, y: 100, hp: 100, maxHp: 100, size: 150, hitFlash: 0, attackTimer: 0 };

        function update() {
            if (gameOver) return;
            bgX = (bgX - 2) % canvas.width;
            if (score >= 540) bombBtn.classList.add('ready');
            else bombBtn.classList.remove('ready');

            if (!gameClear) {
                // キーボード移動
                if (keys['ArrowUp'] && player.y > 0) player.y -= 7;
                if (keys['ArrowDown'] && player.y < canvas.height - player.size) player.y += 7;
                if (keys['ArrowLeft'] && player.x > 0) player.x -= 7;
                if (keys['ArrowRight'] && player.x < canvas.width - player.size) player.x += 7;
                if (keys['Space'] && frames % 6 === 0) fireBullet();

                // 【時間出現】約60秒(3600フレーム)でボス出現
                const timeLeft = Math.max(0, Math.floor((3600 - frames) / 60));
                if (!boss.active) {
                    document.getElementById('timerDisp').innerText = `執着出現まで: ${timeLeft}s`;
                    if (frames >= 3600) {
                        boss.active = true;
                        document.getElementById('bossHpBar').style.display = 'block';
                        document.getElementById('timerDisp').innerText = `決戦`;
                    }
                }

                if (boss.active) {
                    if (boss.x > 550) boss.x -= 1;
                    boss.y = 100 + Math.sin(frames * 0.03) * 100;
                    if (boss.hitFlash > 0) boss.hitFlash--;
                    boss.attackTimer++;
                    if (boss.attackTimer % 120 > 60 && boss.attackTimer % 8 === 0) {
                        const angle = Math.atan2((player.y + 20) - (boss.y + 75), (player.x + 20) - (boss.x + 20));
                        enemies.push({ x: boss.x + 20, y: boss.y + 75, size: 25, vx: Math.cos(angle) * 8, vy: Math.sin(angle) * 8, type: 'laser' });
                    }
                }

                for (let i = bullets.length - 1; i >= 0; i--) {
                    let b = bullets[i]; b.x += b.speed; let hitAny = false;
                    if (boss.active && b.x > boss.x && b.x < boss.x + boss.size && b.y > boss.y && b.y < boss.y + boss.size) {
                        boss.hp--; boss.hitFlash = 3; createExplosion(b.x, b.y, '#f55'); hitAny = true;
                        if (boss.hp <= 0) { gameClear = true; score += 10800; createPetals(); }
                    }
                    if (!hitAny) {
                        for (let j = enemies.length - 1; j >= 0; j--) {
                            let en = enemies[j];
                            if (b.x > en.x && b.x < en.x + en.size && b.y > en.y && b.y < en.y + en.size) {
                                createExplosion(en.x + 15, en.y + 15); enemies.splice(j, 1); score += 108; hitAny = true; break;
                            }
                        }
                    }
                    if (hitAny || b.x > canvas.width) bullets.splice(i, 1);
                }

                // 敵の出現頻度（ボスがいない間はどんどん出す）
                if (!boss.active && frames % 15 === 0) {
                    enemies.push({ x: canvas.width, y: Math.random()*360, size: 35, vx: -(4 + Math.random()*4), vy: 0, type: 'normal' });
                }

                for (let i = enemies.length - 1; i >= 0; i--) {
                    const en = enemies[i]; en.x += en.vx || 0; en.y += (en.type === 'normal' ? Math.sin(frames * 0.1) * 2 : en.vy || 0);
                    if (player.x < en.x + en.size - 10 && player.x + 30 > en.x + 10 && player.y < en.y + en.size - 10 && player.y + 30 > en.y + 10) gameOver = true;
                    if (en.x < -100 || en.x > 900 || en.y < -100 || en.y > 500) enemies.splice(i, 1);
                }
            }
            for (let i = particles.length - 1; i >= 0; i--) { particles[i].x += particles[i].vx; particles[i].y += particles[i].vy; particles[i].life--; if(particles[i].life <= 0) particles.splice(i, 1); }
            petals.forEach(p => { p.x += p.vx; p.y += p.vy; p.angle += p.va; if (p.y > canvas.height) p.y = -p.size; });
            document.getElementById('scoreDisp').innerText = `徳: ${score}`;
            if(boss.active) document.getElementById('bossHpInner').style.width = (boss.hp / boss.maxHp * 100) + '%';
        }

        function draw() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            if (bgImg.complete && bgImg.naturalWidth !== 0) {
                ctx.drawImage(bgImg, bgX, 0, canvas.width, canvas.height); ctx.drawImage(bgImg, bgX + canvas.width, 0, canvas.width, canvas.height);
            } else { ctx.fillStyle = '#050505'; ctx.fillRect(0,0,canvas.width, canvas.height); }
            petals.forEach(p => { ctx.save(); ctx.translate(p.x, p.y); ctx.rotate(p.angle); ctx.fillStyle = p.color; ctx.beginPath(); ctx.ellipse(0, 0, p.size / 2, p.size, 0, 0, Math.PI * 2); ctx.fill(); ctx.restore(); });
            if (!gameClear) {
                ctx.shadowBlur = 15; ctx.shadowColor = '#fff'; ctx.fillStyle = '#fff'; ctx.font = 'bold 40px serif'; ctx.fillText('魁', player.x, player.y + 35);
                ctx.shadowBlur = 10; ctx.shadowColor = '#0ff'; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x, b.y, b.r, 0, Math.PI*2); ctx.fill(); });
                enemies.forEach(en => { 
                    if (en.type === 'normal' && enemyImg.complete && enemyImg.naturalWidth !== 0) {
                        ctx.shadowBlur = 0; ctx.drawImage(enemyImg, en.x, en.y, en.size, en.size);
                    } else {
                        ctx.shadowBlur = 5; ctx.shadowColor = '#f00'; ctx.fillStyle = en.type === 'laser' ? '#ff0' : '#600'; ctx.font = en.type === 'laser' ? '25px serif' : '35px serif'; ctx.fillText('欲', en.x, en.y + en.size/1.2); 
                    }
                });
                if (boss.active) {
                    if (bossImg.complete && bossImg.naturalWidth !== 0) {
                        ctx.shadowBlur = boss.hitFlash > 0 ? 40 : 0; ctx.drawImage(bossImg, boss.x, boss.y, boss.size, boss.size);
                    } else {
                        ctx.shadowBlur = boss.hitFlash > 0 ? 40 : 20; ctx.shadowColor = boss.hitFlash > 0 ? '#fff' : '#f00'; ctx.fillStyle = boss.hitFlash > 0 ? '#fff' : '#300'; ctx.font = 'bold 150px serif'; ctx.fillText('執着', boss.x, boss.y + 120);
                    }
                }
            }
            ctx.shadowBlur = 0; particles.forEach(p => { ctx.globalAlpha = p.life / 50; ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, p.size, p.size); });
            ctx.globalAlpha = 1.0;
            if (gameOver || gameClear) {
                ctx.fillStyle = 'rgba(0,0,0,0.8)'; ctx.fillRect(0,0,canvas.width, canvas.height); ctx.textAlign = 'center';
                if (gameOver) {
                    ctx.fillStyle = '#d4af37'; ctx.font = '40px serif'; ctx.fillText('欲に呑まれし者', canvas.width/2, canvas.height/2);
                    ctx.font = '22px serif'; ctx.fillText('画面タップ又はF5で再び転生', canvas.width/2, canvas.height/2 + 60);
                } else {
                    const rank = getRank(score);
                    ctx.fillStyle = '#fff'; ctx.font = '80px serif'; ctx.fillText('解脱', canvas.width/2, canvas.height/2 - 60);
                    ctx.font = '20px serif'; ctx.fillText(`獲得した徳: ${score}`, canvas.width/2, canvas.height/2 + 10);
                    ctx.fillStyle = rank.color; ctx.font = 'bold 45px serif'; ctx.fillText(`位階: ${rank.name}`, canvas.width/2, canvas.height/2 + 75);
                    ctx.fillStyle = '#d4af37'; ctx.font = '20px serif'; ctx.fillText('画面タップ又はF5で新たなる生へ', canvas.width/2, canvas.height/2 + 150);
                }
            }
        }
        function loop() { frames++; update(); draw(); requestAnimationFrame(loop); }
        loop();
    </script>
</body>
</html>
